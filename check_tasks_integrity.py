# check_tasks_integrity.py
# -*- coding: utf-8 -*-
"""
Script ki·ªÉm tra d·ªØ li·ªáu tasks trong database v√† so s√°nh v·ªõi frontend
"""
import sqlite3
import json
import os
from pathlib import Path
from datetime import datetime

# L·∫•y ƒë∆∞·ªùng d·∫´n database t·ª´ config
config_path = Path(__file__).parent / "config" / "config.json"
with open(config_path, 'r', encoding='utf-8') as f:
    config = json.load(f)

db_path = config['database']['path']
if not os.path.isabs(db_path):
    db_path = Path(__file__).parent / db_path

print(f"üìÇ Database path: {db_path}")
print(f"üìÇ Database exists: {os.path.exists(db_path)}\n")

if not os.path.exists(db_path):
    print("‚ùå Database kh√¥ng t·ªìn t·∫°i!")
    exit(1)

conn = sqlite3.connect(db_path)
conn.row_factory = sqlite3.Row

# Helper function ƒë·ªÉ l·∫•y gi√° tr·ªã t·ª´ sqlite3.Row
def get_row_value(row, key, default=None):
    """L·∫•y gi√° tr·ªã t·ª´ sqlite3.Row v·ªõi default value"""
    if key in row.keys():
        value = row[key]
        return value if value is not None and value != '' else default
    return default

print("=" * 80)
print("üìä KI·ªÇM TRA TASKS DATABASE")
print("=" * 80)

# 1. Ki·ªÉm tra schema b·∫£ng tasks
print("\nüìã 1. C·∫§U TR√öC B·∫¢NG TASKS:")
cursor = conn.cursor()
cursor.execute("PRAGMA table_info(tasks)")
columns_info = cursor.fetchall()
columns = [col[1] for col in columns_info]

print(f"   T·ªïng s·ªë c·ªôt: {len(columns)}")
print(f"   Danh s√°ch c·ªôt:")
for col in columns_info:
    col_name = col[1]
    col_type = col[2]
    not_null = "NOT NULL" if col[3] else "NULL"
    default = f"DEFAULT {col[4]}" if col[4] is not None else ""
    print(f"      - {col_name}: {col_type} {not_null} {default}")

# 2. Ki·ªÉm tra d·ªØ li·ªáu tasks
print("\nüìã 2. D·ªÆ LI·ªÜU TASKS:")
tasks_count = cursor.execute("SELECT COUNT(*) FROM tasks").fetchone()[0]
print(f"   T·ªïng s·ªë tasks: {tasks_count}")

if tasks_count > 0:
    # L·∫•y t·∫•t c·∫£ tasks
    tasks = cursor.execute("SELECT * FROM tasks ORDER BY created_at DESC").fetchall()
    
    # Ph√¢n t√≠ch theo user_id
    tasks_by_user = {}
    tasks_no_user = []
    tasks_invalid_user = []
    
    for task in tasks:
        user_id = task['user_id'] if 'user_id' in task.keys() and task['user_id'] else None
        if not user_id:
            tasks_no_user.append(task)
        else:
            # Ki·ªÉm tra user c√≥ t·ªìn t·∫°i kh√¥ng
            user_check = conn.execute("SELECT 1 FROM users WHERE user_id = ?", (user_id,)).fetchone()
            if not user_check:
                tasks_invalid_user.append(task)
            
            if user_id not in tasks_by_user:
                tasks_by_user[user_id] = []
            tasks_by_user[user_id].append(task)
    
    print(f"\n   üìä PH√ÇN T√çCH:")
    print(f"      - Tasks c√≥ user_id h·ª£p l·ªá: {tasks_count - len(tasks_no_user) - len(tasks_invalid_user)}")
    print(f"      - Tasks KH√îNG c√≥ user_id: {len(tasks_no_user)}")
    print(f"      - Tasks c√≥ user_id KH√îNG t·ªìn t·∫°i: {len(tasks_invalid_user)}")
    print(f"      - S·ªë users c√≥ tasks: {len(tasks_by_user)}")
    
    # Chi ti·∫øt tasks kh√¥ng c√≥ user
    if tasks_no_user:
        print(f"\n   ‚ö†Ô∏è  TASKS KH√îNG C√ì USER_ID ({len(tasks_no_user)}):")
        for task in tasks_no_user[:5]:  # Hi·ªÉn th·ªã 5 ƒë·∫ßu ti√™n
            print(f"      - {task['task_id']}: '{get_row_value(task, 'title', 'N/A')}' (created: {get_row_value(task, 'created_at', 'N/A')})")
        if len(tasks_no_user) > 5:
            print(f"      ... v√† {len(tasks_no_user) - 5} tasks kh√°c")
    
    # Chi ti·∫øt tasks c√≥ user_id kh√¥ng h·ª£p l·ªá
    if tasks_invalid_user:
        print(f"\n   ‚ùå TASKS C√ì USER_ID KH√îNG T·ªíN T·∫†I ({len(tasks_invalid_user)}):")
        for task in tasks_invalid_user[:5]:
            print(f"      - {task['task_id']}: user_id='{get_row_value(task, 'user_id')}', title='{get_row_value(task, 'title', 'N/A')}'")
        if len(tasks_invalid_user) > 5:
            print(f"      ... v√† {len(tasks_invalid_user) - 5} tasks kh√°c")

    # Th·ªëng k√™ notif1-8
    print(f"\n   üìä TH·ªêNG K√ä NOTIFICATIONS (notif1-8):")
    notif_stats = {}
    for i in range(1, 9):
        notif_key = f'notif{i}'
        if notif_key in columns:
            count = cursor.execute(f"SELECT COUNT(*) FROM tasks WHERE {notif_key} IS NOT NULL AND {notif_key} != ''").fetchone()[0]
            notif_stats[notif_key] = count
            print(f"      - {notif_key}: {count} tasks c√≥ gi√° tr·ªã")
    
    # Hi·ªÉn th·ªã tasks theo user
    print(f"\n   üìù TASKS THEO USER (top 10 tasks g·∫ßn nh·∫•t):")
    for idx, task in enumerate(tasks[:10], 1):
        task_id = task['task_id']
        title = task['title'] or '(no title)'
        user_id = task['user_id'] if 'user_id' in task.keys() and task['user_id'] else '(no user)'
        status = task['status'] if 'status' in task.keys() and task['status'] else 'pending'
        created_at = task['created_at'] if 'created_at' in task.keys() and task['created_at'] else 'N/A'
        
        # L·∫•y th√¥ng tin user
        user_info = 'N/A'
        if user_id and user_id != '(no user)':
            user_row = conn.execute("""
                SELECT display_name, email, phone_number 
                FROM users 
                WHERE user_id = ?
            """, (user_id,)).fetchone()
            if user_row:
                user_info = f"{user_row['display_name'] or user_row['email'] or user_id}"
        
        print(f"\n   [{idx}] Task ID: {task_id}")
        print(f"       Title: {title}")
        print(f"       User: {user_id} ({user_info})")
        print(f"       Status: {status}")
        print(f"       Created: {created_at}")
        
        # Hi·ªÉn th·ªã c√°c tr∆∞·ªùng quan tr·ªçng
        if 'description' in columns and task['description']:
            desc = task['description']
            print(f"       Description: {desc[:80]}{'...' if len(desc) > 80 else ''}")
        if 'start_date' in columns and task['start_date']:
            print(f"       Start Date: {task['start_date']}")
        if 'end_date' in columns and task['end_date']:
            print(f"       End Date: {task['end_date']}")
        if 'deadline' in columns and task['deadline']:
            print(f"       Deadline: {task['deadline']}")
        if 'notification_time' in columns and task['notification_time']:
            print(f"       Notification Time: {task['notification_time']}")
        
        # Hi·ªÉn th·ªã c√°c c·ªôt notif1-8
        print(f"       Notifications:")
        for i in range(1, 9):
            notif_key = f'notif{i}'
            if notif_key in columns:
                notif_val = task[notif_key] if task[notif_key] else '(empty)'
                print(f"         Notif{i}: {notif_val}")
        
        if 'priority' in columns and task['priority']:
            print(f"       Priority: {task['priority']}")
        if 'category' in columns and task['category']:
            print(f"       Category: {task['category']}")

# 3. Ki·ªÉm tra Calendar Events
print("\nüìã 3. D·ªÆ LI·ªÜU CALENDAR_EVENTS:")
events_count = cursor.execute("SELECT COUNT(*) FROM calendar_events").fetchone()[0]
print(f"   T·ªïng s·ªë events: {events_count}")

if events_count > 0:
    # Events kh√¥ng c√≥ task t∆∞∆°ng ·ª©ng (orphaned)
    orphaned_events = cursor.execute("""
        SELECT e.* 
        FROM calendar_events e
        LEFT JOIN tasks t ON e.task_id = t.task_id
        WHERE t.task_id IS NULL
    """).fetchall()
    
    print(f"   - Events orphaned (kh√¥ng c√≥ task): {len(orphaned_events)}")
    
    # Events kh√¥ng c√≥ user_id
    events_no_user = cursor.execute("""
        SELECT COUNT(*) FROM calendar_events WHERE user_id IS NULL OR user_id = ''
    """).fetchone()[0]
    print(f"   - Events kh√¥ng c√≥ user_id: {events_no_user}")
    
    # Events c√≥ user_id nh∆∞ng user kh√¥ng t·ªìn t·∫°i
    events_invalid_user = cursor.execute("""
        SELECT COUNT(*) 
        FROM calendar_events e
        LEFT JOIN users u ON e.user_id = u.user_id
        WHERE e.user_id IS NOT NULL AND e.user_id != '' AND u.user_id IS NULL
    """).fetchone()[0]
    print(f"   - Events c√≥ user_id kh√¥ng t·ªìn t·∫°i: {events_invalid_user}")
    
    if orphaned_events:
        print(f"\n   ‚ö†Ô∏è  ORPHANED EVENTS ({len(orphaned_events)}):")
        for event in orphaned_events[:5]:
            print(f"      - {event['event_id']}: task_id='{event.get('task_id')}', title='{event.get('title', 'N/A')}'")
        if len(orphaned_events) > 5:
            print(f"      ... v√† {len(orphaned_events) - 5} events kh√°c")

# 4. Ki·ªÉm tra Notifications
print("\nüìã 4. D·ªÆ LI·ªÜU NOTIFICATIONS:")
notifs_count = cursor.execute("SELECT COUNT(*) FROM notifications").fetchone()[0]
print(f"   T·ªïng s·ªë notifications: {notifs_count}")

if notifs_count > 0:
    # Notifications kh√¥ng c√≥ task t∆∞∆°ng ·ª©ng (orphaned)
    orphaned_notifs = cursor.execute("""
        SELECT n.* 
        FROM notifications n
        LEFT JOIN tasks t ON n.task_id = t.task_id
        WHERE n.task_id IS NOT NULL AND t.task_id IS NULL
    """).fetchall()
    
    print(f"   - Notifications orphaned (kh√¥ng c√≥ task): {len(orphaned_notifs)}")
    
    # Notifications theo status
    notifs_by_status = cursor.execute("""
        SELECT status, COUNT(*) as cnt
        FROM notifications
        GROUP BY status
    """).fetchall()
    
    print(f"\n   üìä NOTIFICATIONS THEO STATUS:")
    for row in notifs_by_status:
        print(f"      - {row['status']}: {row['cnt']}")
    
    # Notifications theo task v√† user
    notifs_with_task_info = cursor.execute("""
        SELECT 
            n.notification_id,
            n.task_id,
            n.status,
            n.scheduled_time,
            t.title as task_title,
            t.user_id,
            COALESCE(u.display_name, u.email, u.phone_number, t.user_id) as user_label
        FROM notifications n
        LEFT JOIN tasks t ON n.task_id = t.task_id
        LEFT JOIN users u ON t.user_id = u.user_id
        ORDER BY n.scheduled_time DESC
        LIMIT 10
    """).fetchall()
    
    if notifs_with_task_info:
        print(f"\n   üìù NOTIFICATIONS G·∫¶N NH·∫§T (top 10):")
        for idx, notif in enumerate(notifs_with_task_info, 1):
            print(f"\n   [{idx}] Notification ID: {notif['notification_id']}")
            print(f"       Task: {notif['task_id'] or 'N/A'} - '{notif['task_title'] or 'N/A'}'")
            print(f"       User: {notif['user_id'] or 'N/A'} ({notif['user_label'] or 'N/A'})")
            print(f"       Status: {notif['status']}")
            print(f"       Scheduled: {notif['scheduled_time'] or 'N/A'}")
    
    if orphaned_notifs:
        print(f"\n   ‚ö†Ô∏è  ORPHANED NOTIFICATIONS ({len(orphaned_notifs)}):")
        for notif in orphaned_notifs[:5]:
            task_id = notif['task_id'] if 'task_id' in notif.keys() and notif['task_id'] else 'N/A'
            print(f"      - {notif['notification_id']}: task_id='{task_id}'")
        if len(orphaned_notifs) > 5:
            print(f"      ... v√† {len(orphaned_notifs) - 5} notifications kh√°c")

# 5. So s√°nh v·ªõi c√°ch frontend l·∫•y tasks
print("\nüìã 5. SO S√ÅNH V·ªöI FRONTEND:")
print("   Frontend route /tasks l·∫•y tasks b·∫±ng: task_manager.get_tasks(user_id=session['user_id'])")
print("   (Filter theo user_id t·ª´ session)")

# L·∫•y danh s√°ch users c√≥ tasks
print(f"\n   üìä TASKS THEO USER:")
for user_id, user_tasks in sorted(tasks_by_user.items(), key=lambda x: len(x[1]), reverse=True)[:10]:
    user_row = conn.execute("""
        SELECT display_name, email, phone_number 
        FROM users 
        WHERE user_id = ?
    """, (user_id,)).fetchone()
    
    if user_row:
        user_label = user_row['display_name'] or user_row['email'] or user_row['phone_number'] or user_id
    else:
        user_label = f"{user_id} (KH√îNG T·ªíN T·∫†I)"
    
    print(f"      - {user_label}: {len(user_tasks)} tasks")

# 6. T√≥m t·∫Øt c√°c v·∫•n ƒë·ªÅ
print("\n" + "=" * 80)
print("üìä T√ìM T·∫ÆT V·∫§N ƒê·ªÄ:")
print("=" * 80)

issues = []

if tasks_no_user:
    issues.append(f"‚ö†Ô∏è  {len(tasks_no_user)} tasks KH√îNG c√≥ user_id")
if tasks_invalid_user:
    issues.append(f"‚ùå {len(tasks_invalid_user)} tasks c√≥ user_id KH√îNG t·ªìn t·∫°i")
if orphaned_events:
    issues.append(f"‚ö†Ô∏è  {len(orphaned_events)} calendar_events orphaned (kh√¥ng c√≥ task)")
if orphaned_notifs:
    issues.append(f"‚ö†Ô∏è  {len(orphaned_notifs)} notifications orphaned (kh√¥ng c√≥ task)")

if issues:
    print("\n   C√°c v·∫•n ƒë·ªÅ c·∫ßn x·ª≠ l√Ω:")
    for issue in issues:
        print(f"   {issue}")
else:
    print("\n   ‚úÖ Kh√¥ng c√≥ v·∫•n ƒë·ªÅ! Database nh·∫•t qu√°n.")

print("\n" + "=" * 80)
print("‚úÖ Ho√†n t·∫•t ki·ªÉm tra!")
print("=" * 80)

conn.close()