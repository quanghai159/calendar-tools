{% extends "base_adminlte.html" %}

{% block title %}Qu·∫£n l√Ω T√°c v·ª• - Hunonic Marketing Tools{% endblock %}

{% block page_title %}Qu·∫£n l√Ω T√°c v·ª•{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Trang ch·ªß</a></li>
<li class="breadcrumb-item active">Qu·∫£n l√Ω T√°c v·ª•</li>
{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/datetime-picker.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/tasks-page.css') }}" rel="stylesheet">
<!-- DataTables FixedColumns CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/4.3.0/css/fixedColumns.bootstrap5.min.css">
{% endblock %}

{% block content %}
<!-- X√≥a ph·∫ßn Action Buttons ·ªü ƒë·∫ßu, chuy·ªÉn v√†o card-tools -->
<!-- Ho·∫∑c gi·ªØ l·∫°i nh∆∞ng d√πng AdminLTE button group -->
<div class="row mb-3">
    <div class="col-12">
        <div class="btn-group" role="group" aria-label="Action buttons">
            <a href="{{ url_for('create_simple_task') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> T·∫°o T√°c v·ª• M·ªõi
            </a>
            <a href="{{ url_for('process_notifications') }}" class="btn btn-warning">
                <i class="fas fa-bell"></i> X·ª≠ L√Ω Th√¥ng B√°o
            </a>
        </div>
    </div>
</div>

<!-- Tasks Table Card -->
<div class="card card-primary card-outline">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-list"></i> Danh S√°ch T√°c V·ª•
            <span class="badge bg-primary ms-2">{{ tasks|length }}</span>
        </h3>
        <div class="card-tools">
            <a href="{{ url_for('create_simple_task') }}" class="btn btn-primary btn-sm">
                <i class="fas fa-plus"></i> T·∫°o m·ªõi
            </a>
        </div>
    </div>
    <!-- S·ª≠a t·ª´ d√≤ng 46-192 -->
    <div class="card-body p-0">
        {% if tasks %}
        <div class="table-responsive task-table-wrapper">
            <table id="tasks-table" class="table table-bordered table-hover table-striped task-table mb-0">
                <thead>
                    <tr>
                        <th style="width: 60px;">STT</th>
                        <th style="min-width: 200px;">Ti√™u ƒë·ªÅ</th>
                        <th style="min-width: 200px;">M√¥ t·∫£</th>
                        <th style="min-width: 180px;">B·∫Øt ƒë·∫ßu</th>
                        <th style="min-width: 180px;">K·∫øt th√∫c</th>
                        <th style="min-width: 180px;">Deadline</th>
                        <th style="min-width: 180px;">Ng√†y th√¥ng b√°o</th>
                        <th style="min-width: 150px;">{{ notif_labels[0] }}</th>
                        <th style="min-width: 150px;">{{ notif_labels[1] }}</th>
                        <th style="min-width: 150px;">{{ notif_labels[2] }}</th>
                        <th style="min-width: 150px;">{{ notif_labels[3] }}</th>
                        <th style="min-width: 150px;">{{ notif_labels[4] }}</th>
                        <th style="min-width: 150px;">{{ notif_labels[5] }}</th>
                        <th style="min-width: 150px;">{{ notif_labels[6] }}</th>
                        <th style="min-width: 150px;">{{ notif_labels[7] }}</th>
                        <th style="min-width: 120px;">Tr·∫°ng th√°i</th>
                        <th style="min-width: 150px;">Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    {% set offsets = task_offsets.get(task.task_id, {}) %}
                    <tr data-task-id="{{ task.task_id }}">
                        <td>{{ loop.index }}</td>
                        <td contenteditable="true">{{ task.title }}</td>
                        <td contenteditable="true">{{ task.description }}</td>
                        
                        <!-- Datetime inputs v·ªõi wrapper -->
                        <td>
                            <div class="datetime-input-wrapper">
                                <input type="datetime-local" 
                                       class="form-control form-control-sm datetime-input" 
                                       data-column="start_date"
                                       {% if offsets.get('start_date') %}data-ref-offset="{{ offsets.get('start_date') }}"{% endif %}
                                       value="{{ (task.start_date or '')|replace(' ', 'T') }}" 
                                       placeholder="--/--/---- --:--"
                                       readonly>
                            </div>
                        </td>
                        <td>
                            <div class="datetime-input-wrapper">
                                <input type="datetime-local" 
                                       class="form-control form-control-sm datetime-input" 
                                       data-column="end_date"
                                       {% if offsets.get('end_date') %}data-ref-offset="{{ offsets.get('end_date') }}"{% endif %}
                                       value="{{ (task.end_date or '')|replace(' ', 'T') }}" 
                                       placeholder="--/--/---- --:--"
                                       readonly>
                            </div>
                        </td>
                        <td>
                            <div class="datetime-input-wrapper">
                                <input type="datetime-local" 
                                       class="form-control form-control-sm datetime-input" 
                                       data-column="deadline"
                                       {% if offsets.get('deadline') %}data-ref-offset="{{ offsets.get('deadline') }}"{% endif %}
                                       value="{{ (task.deadline or '')|replace(' ', 'T') }}" 
                                       placeholder="--/--/---- --:--"
                                       readonly>
                            </div>
                        </td>
                        <td>
                            <div class="datetime-input-wrapper">
                                <input type="datetime-local" 
                                       class="form-control form-control-sm datetime-input" 
                                       data-column="notification_time"
                                       {% if offsets.get('notification_time') %}data-ref-offset="{{ offsets.get('notification_time') }}"{% endif %}
                                       value="{{ (task.notification_time or '')|replace(' ', 'T') }}" 
                                       placeholder="--/--/---- --:--"
                                       readonly>
                            </div>
                        </td>
                        
                        <!-- Notif1-8 -->
                        {% for i in range(1, 9) %}
                        <td>
                            <div class="datetime-input-wrapper">
                                <input type="datetime-local" 
                                       class="form-control form-control-sm datetime-input" 
                                       data-column="notif{{ i }}"
                                       {% if offsets.get('notif' + i|string) %}data-ref-offset="{{ offsets.get('notif' + i|string) }}"{% endif %}
                                       value="{{ (task['notif' + i|string] or '')|replace(' ', 'T') }}" 
                                       placeholder="--/--/---- --:--"
                                       readonly>
                            </div>
                        </td>
                        {% endfor %}
                        
                        <!-- Status -->
                        <td>
                            <select class="form-control form-control-sm" onchange="updateStatus(this, '{{ task.task_id }}')">
                                <option value="pending" {% if task.status == 'pending' %}selected{% endif %}>Ch·ªù x·ª≠ l√Ω</option>
                                <option value="in_progress" {% if task.status == 'in_progress' %}selected{% endif %}>ƒêang l√†m</option>
                                <option value="completed" {% if task.status == 'completed' %}selected{% endif %}>Ho√†n th√†nh</option>
                                <option value="cancelled" {% if task.status == 'cancelled' %}selected{% endif %}>ƒê√£ h·ªßy</option>
                            </select>
                        </td>
                        
                        <!-- Actions -->
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-info btn-sm" onclick="testTask(this)" title="Test th√¥ng b√°o">
                                    <i class="fas fa-bell"></i>
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="duplicateRow(this)" title="Nh√¢n b·∫£n">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteRow(this)" title="X√≥a">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <!-- Di chuy·ªÉn button ra ƒë√¢y -->
        <div class="card-footer">
            <button class="btn btn-primary btn-sm" onclick="addNewTaskRow()">
                <i class="fas fa-plus"></i> T·∫°o t√°c v·ª• m·ªõi
            </button>
        </div>
        
        <!-- Save All Button Wrapper -->
        <div class="save-all-wrapper" id="saveAllWrapper"></div>
        
        {% else %}
        <div class="callout callout-info">
            <h5><i class="icon fas fa-info-circle"></i> Ch∆∞a c√≥ t√°c v·ª•</h5>
            <p>B·∫°n ch∆∞a c√≥ t√°c v·ª• n√†o. <a href="{{ url_for('create_simple_task') }}" class="btn btn-primary btn-sm">
                <i class="fas fa-plus"></i> T·∫°o t√°c v·ª• m·ªõi
            </a></p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- DataTables FixedColumns JS -->
<script src="https://cdn.datatables.net/fixedcolumns/4.3.0/js/dataTables.fixedColumns.min.js"></script>

<!-- Load existing JS modules -->
<script src="{{ url_for('static', filename='js/datetime-picker.js') }}"></script>
<script src="{{ url_for('static', filename='js/datetime-copy-paste.js') }}"></script>
<script src="{{ url_for('static', filename='js/task-actions.js') }}"></script>

<script>
// Helper function ƒë·ªÉ hi·ªÉn th·ªã flash messages - AdminLTE style
window.showFlash = function(message, type) {
    type = type || 'info';
    const alertClass = type === 'error' ? 'danger' : type;
    const icon = type === 'error' ? 'exclamation-triangle' : 
                 type === 'success' ? 'check-circle' : 'info-circle';
    
    const alertHtml = `
        <div class="alert alert-${alertClass} alert-dismissible fade show" role="alert">
            <i class="fas fa-${icon} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    
    // Insert v√†o ƒë·∫ßu content wrapper
    const contentWrapper = document.querySelector('.content');
    if (contentWrapper) {
        contentWrapper.insertAdjacentHTML('afterbegin', alertHtml);
        
        // Auto-hide sau 5 gi√¢y
        setTimeout(() => {
            const alert = contentWrapper.querySelector('.alert');
            if (alert) {
                // D√πng Bootstrap 5 dismiss
                const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
                bsAlert.close();
            }
        }, 5000);
    } else {
        // Fallback: d√πng alert n·∫øu kh√¥ng t√¨m th·∫•y content wrapper
        alert(message);
    }
};

// Get row data helper
function getRowData(btn) {
    const tr = btn.closest('tr');
    const tds = tr.querySelectorAll('td');
    return {
        tr,
        task_id: tr.getAttribute('data-task-id') || '',
        title: tds[1].innerText.trim(),
        description: tds[2].innerText.trim(),
        start_date: tds[3].querySelector('.datetime-input')?.value || '',
        end_date: tds[4].querySelector('.datetime-input')?.value || '',
        deadline: tds[5].querySelector('.datetime-input')?.value || '',
        notification_time: tds[6].querySelector('.datetime-input')?.value || '',
        notif1: tds[7].querySelector('.datetime-input')?.value || '',
        notif2: tds[8].querySelector('.datetime-input')?.value || '',
        notif3: tds[9].querySelector('.datetime-input')?.value || '',
        notif4: tds[10].querySelector('.datetime-input')?.value || '',
        notif5: tds[11].querySelector('.datetime-input')?.value || '',
        notif6: tds[12].querySelector('.datetime-input')?.value || '',
        notif7: tds[13].querySelector('.datetime-input')?.value || '',
        notif8: tds[14].querySelector('.datetime-input')?.value || '',
        status: tds[15].querySelector('select')?.value || 'pending'
    };
}

// Save row function
function saveRow(btn) {
    const data = getRowData(btn);
    // ‚úÖ FIX: Ki·ªÉm tra c·∫£ "NEW" v√† empty string
    const isNew = !data.task_id || data.task_id === 'NEW' || data.task_id === '';
    const url = isNew ? '/api/task' : `/api/task/${data.task_id}`;
    
    console.log('üîç DEBUG saveRow:', {
        task_id: data.task_id,
        isNew: isNew,
        url: url
    });

    // Thu th·∫≠p offsets
    const offsets = {};
    const allInputs = data.tr.querySelectorAll('.datetime-input');
    allInputs.forEach(function(input) {
        const column = input.getAttribute('data-column');
        const offset = input.getAttribute('data-ref-offset');
        if (offset) {
            offsets[column] = offset;
        }
    });

    const payload = {
        title: data.title,
        description: data.description,
        start_date: data.start_date,
        end_date: data.end_date,
        deadline: data.deadline,
        notification_time: data.notification_time,
        notif1: data.notif1,
        notif2: data.notif2,
        notif3: data.notif3,
        notif4: data.notif4,
        notif5: data.notif5,
        notif6: data.notif6,
        notif7: data.notif7,
        notif8: data.notif8,
        status: data.status,
        offsets: offsets
    };

    fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(res => {
        if (res.status === 'success') {
            if (isNew && res.task_id) {
                data.tr.setAttribute('data-task-id', res.task_id);
            }
            
            // Remove dirty flag
            data.tr.removeAttribute('data-dirty');
            TaskActions.updateSaveAllButton();
            
            showFlash('ƒê√£ l∆∞u th√†nh c√¥ng!', 'success');
        } else {
            showFlash('L∆∞u th·∫•t b·∫°i: ' + (res.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'), 'error');
        }
    })
    .catch(error => {
        console.error('‚ùå Error saving row:', error);
        showFlash('L·ªói khi l∆∞u: ' + error.message, 'error');
    });
}

// Restore reference notes
function restoreReferenceNotes(row) {
    const datetimeInputs = row.querySelectorAll('.datetime-input');
    
    datetimeInputs.forEach(function(input) {
        const offset = input.getAttribute('data-ref-offset');
        
        if (offset && window.DateTimePicker && window.DateTimePicker.showReferenceNote) {
            window.DateTimePicker.showReferenceNote(input, offset);
        }
    });
}

// Restore all reference notes on page load
function restoreAllReferenceNotes() {
    const inputs = document.querySelectorAll('.datetime-input[data-ref-offset]');
    
    inputs.forEach(function(input) {
        const offset = input.getAttribute('data-ref-offset');
        if (offset && window.DateTimePicker && window.DateTimePicker.showReferenceNote) {
            window.DateTimePicker.showReferenceNote(input, offset);
        }
    });
}

// Test task notification
function testTask(btn) {
    const { task_id } = getRowData(btn);
    if (!task_id) {
        showFlash('B·∫°n c·∫ßn l∆∞u ƒë·ªÉ t·∫°o task tr∆∞·ªõc khi test.', 'error');
        return;
    }
    
    fetch(`/api/task/${task_id}/test_notification`, { method: 'POST' })
        .then(r => r.json())
        .then(res => {
            showFlash(res.message || 'ƒê√£ g·ª≠i test', res.status || 'success');
        })
        .catch(() => {
            showFlash('L·ªói test Telegram!', 'error');
        });
}

// Delete row
function deleteRow(btn) {
    const { tr, task_id } = getRowData(btn);
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a task n√†y kh√¥ng?')) return;
    
    // ‚úÖ FIX: N·∫øu l√† NEW ho·∫∑c empty, ch·ªâ c·∫ßn remove kh·ªèi DOM
    if (!task_id || task_id === 'NEW' || task_id.trim() === '') {
        tr.remove();
        if (window.TaskActions) {
            window.TaskActions.updateSaveAllButton();
        }
        showFlash('ƒê√£ x√≥a task kh·ªèi danh s√°ch', 'success');
        return;
    }
    
    // X√≥a t·ª´ server
    fetch(`/api/task/${task_id}`, { method: 'DELETE' })
        .then(r => r.json())
        .then(res => {
            if (res.status === 'success') {
                tr.remove();
                if (window.TaskActions) {
                    window.TaskActions.updateSaveAllButton();
                }
                showFlash('ƒê√£ x√≥a task', 'success');
            } else {
                showFlash('L·ªói: ' + (res.message || 'Kh√¥ng th·ªÉ x√≥a'), 'error');
            }
        })
        .catch((error) => {
            console.error('‚ùå Error deleting:', error);
            showFlash('L·ªói k·∫øt n·ªëi khi x√≥a!', 'error');
        });
}

// Add new task row - Updated for DataTables
function addNewTaskRow() {
    console.log('üîç DEBUG addNewTaskRow: START');
    
    // ‚úÖ FIX: Ki·ªÉm tra DataTable ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o ch∆∞a
    if (!window.tasksDataTable) {
        console.error('DataTable not initialized');
        console.log('  - Checking if table exists:', $('#tasks-table').length);
        console.log('  - window.tasksDataTable:', window.tasksDataTable);
        
        // Th·ª≠ kh·ªüi t·∫°o l·∫°i n·∫øu table t·ªìn t·∫°i
        if ($('#tasks-table').length) {
            console.log('  - Attempting to re-initialize DataTable...');
            // G·ªçi l·∫°i initialization
            $(document).ready(function() {
                // Code initialization ·ªü ƒë√¢y ho·∫∑c trigger l·∫°i
            });
            alert('ƒêang kh·ªüi t·∫°o b·∫£ng... Vui l√≤ng th·ª≠ l·∫°i sau 1 gi√¢y.');
            setTimeout(function() {
                if (window.tasksDataTable) {
                    addNewTaskRow();
                } else {
                    alert('Kh√¥ng th·ªÉ kh·ªüi t·∫°o b·∫£ng. Vui l√≤ng refresh trang.');
                }
            }, 1000);
        } else {
            alert('B·∫£ng ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o. Vui l√≤ng refresh trang.');
        }
        return;
    }
    
    // L·∫•y s·ªë th·ª© t·ª± m·ªõi (d·ª±a tr√™n s·ªë rows hi·ªán t·∫°i trong DataTable)
    const currentRows = window.tasksDataTable.rows().count();
    const newIndex = currentRows + 1;
    
    console.log('  - Current rows:', currentRows);
    console.log('  - New index:', newIndex);
    
    // T·∫°o array data cho DataTable (17 columns)
    const rowData = [];
    
    // STT
    rowData.push(newIndex);
    
    // Ti√™u ƒë·ªÅ (editable)
    rowData.push('');
    
    // M√¥ t·∫£ (editable)
    rowData.push('');
    
    // Datetime columns: start_date, end_date, deadline, notification_time
    rowData.push(''); // start_date
    rowData.push(''); // end_date
    rowData.push(''); // deadline
    rowData.push(''); // notification_time
    
    // Notif1-8
    for (let i = 1; i <= 8; i++) {
        rowData.push('');
    }
    
    // Status
    rowData.push('pending');
    
    // Actions (empty, s·∫Ω ƒë∆∞·ª£c render sau)
    rowData.push('');
    
    // Th√™m row v√†o DataTable
    const rowNode = window.tasksDataTable.row.add(rowData).draw(false).node();

    // ‚úÖ FIX 2: T√≠nh to√°n trang v√† chuy·ªÉn ƒë·∫øn trang ch·ª©a row m·ªõi
    const pageLength = window.tasksDataTable.page.len();
    const totalRows = window.tasksDataTable.rows().count(); // Bao g·ªìm c·∫£ row m·ªõi
    const lastPageIndex = Math.floor((totalRows - 1) / pageLength); // Index c·ªßa trang cu·ªëi (0-based)

    // Chuy·ªÉn ƒë·∫øn trang cu·ªëi
    window.tasksDataTable.page(lastPageIndex).draw(false);
    
    // Set attributes cho row
    rowNode.setAttribute('data-task-id', 'NEW');
    rowNode.setAttribute('data-dirty', 'true');
    
    console.log('  - Row added to DataTable:', rowNode);
    
    // ‚úÖ FIX: L·∫•y cells t·ª´ rowNode (kh√¥ng t·∫°o m·ªõi)
    const cells = rowNode.querySelectorAll('td');
    console.log('  - Found cells:', cells.length);
    
    if (cells.length < 17) {
        console.error('  ‚ùå Wrong number of cells:', cells.length);
        return;
    }
    
    // STT (cell 0)
    cells[0].textContent = newIndex;
    
    // Ti√™u ƒë·ªÅ (cell 1) - editable
    cells[1].contentEditable = 'true';
    cells[1].textContent = '';
    
    // M√¥ t·∫£ (cell 2) - editable
    cells[2].contentEditable = 'true';
    cells[2].textContent = '';
    
    // Datetime columns (cells 3-6)
    const datetimeColumns = ['start_date', 'end_date', 'deadline', 'notification_time'];
    datetimeColumns.forEach(function(column, idx) {
        const cell = cells[3 + idx];
        if (cell) {
            cell.innerHTML = `
                <div class="datetime-input-wrapper">
                    <input type="datetime-local" 
                           class="form-control form-control-sm datetime-input" 
                           data-column="${column}"
                           placeholder="--/--/---- --:--"
                           readonly>
                </div>
            `;
        }
    });
    
    // Notif1-8 (cells 7-14)
    for (let i = 1; i <= 8; i++) {
        const cell = cells[6 + i];
        if (cell) {
            cell.innerHTML = `
                <div class="datetime-input-wrapper">
                    <input type="datetime-local" 
                           class="form-control form-control-sm datetime-input" 
                           data-column="notif${i}"
                           placeholder="--/--/---- --:--"
                           readonly>
                </div>
            `;
        }
    }
    
    // Status (cell 15)
    if (cells[15]) {
        cells[15].innerHTML = `
            <select class="form-control form-control-sm" onchange="updateStatus(this, 'NEW')">
                <option value="pending" selected>Ch·ªù x·ª≠ l√Ω</option>
                <option value="in_progress">ƒêang l√†m</option>
                <option value="completed">Ho√†n th√†nh</option>
                <option value="cancelled">ƒê√£ h·ªßy</option>
            </select>
        `;
    }
    
    // Actions (cell 16)
    if (cells[16]) {
        cells[16].innerHTML = `
            <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-info btn-sm" onclick="testTask(this)" title="Test th√¥ng b√°o" disabled>
                    <i class="fas fa-bell"></i>
                </button>
                <button class="btn btn-outline-info btn-sm" onclick="duplicateRow(this)" title="Nh√¢n b·∫£n" disabled>
                    <i class="fas fa-copy"></i>
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteRow(this)" title="X√≥a">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
    }
    
    console.log('  - Cells updated');
    
    // Initialize datetime pickers cho row m·ªõi
    setTimeout(function() {
        console.log('  - Initializing datetime pickers...');
        
        // T√¨m l·∫°i rowNode sau khi DataTables render
        const updatedRowNode = document.querySelector(`tr[data-task-id="NEW"]:last-child`);
        if (!updatedRowNode) {
            console.error('  ‚ùå Cannot find new row node');
            return;
        }
        
        // Initialize cho row m·ªõi n√†y
        const newInputs = updatedRowNode.querySelectorAll('.datetime-input');
        console.log(`  - Found ${newInputs.length} datetime inputs in new row`);
        
        if (window.DateTimePicker) {
            // Initialize t·ª´ng input trong row m·ªõi
            newInputs.forEach(function(input) {
                // ƒê·∫£m b·∫£o c√≥ wrapper
                let wrapper = input.closest('.datetime-input-wrapper');
                if (!wrapper) {
                    wrapper = document.createElement('div');
                    wrapper.className = 'datetime-input-wrapper';
                    input.parentNode.insertBefore(wrapper, input);
                    wrapper.appendChild(input);
                }
                
                // T·∫°o popup v√† setup events
                if (window.DateTimePicker.createPopupForInput) {
                    window.DateTimePicker.createPopupForInput(input);
                }
                if (window.DateTimePicker.setupInputEvents) {
                    window.DateTimePicker.setupInputEvents(input);
                }
            });
        }
        
        if (window.DateTimeCopyPaste && window.DateTimeCopyPaste.initializeCopyPaste) {
            window.DateTimeCopyPaste.initializeCopyPaste();
        }
        
        console.log('  - DateTime pickers initialized');
    }, 200);
    
    // Update save all button
    if (window.TaskActions) {
        window.TaskActions.updateSaveAllButton();
    }
    
    // Scroll to new row
    setTimeout(function() {
        const newRow = document.querySelector(`tr[data-task-id="NEW"]:last-child`);
        if (newRow) {
            newRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Highlight
            const originalBg = newRow.style.backgroundColor;
            newRow.style.transition = 'background-color 0.3s';
            newRow.style.backgroundColor = '#fff3cd';
            setTimeout(function() {
                newRow.style.backgroundColor = originalBg;
            }, 1000);
        }
    }, 300);
    
    showFlash('ƒê√£ th√™m row m·ªõi. Vui l√≤ng ƒëi·ªÅn th√¥ng tin v√† l∆∞u.', 'success');
    console.log('üîç DEBUG addNewTaskRow: COMPLETE');
}

// Expose function globally ƒë·ªÉ onclick c√≥ th·ªÉ g·ªçi
window.addNewTaskRow = addNewTaskRow;

// Duplicate row
function duplicateRow(btn) {
    if (window.TaskActions && window.TaskActions.duplicateRow) {
        window.TaskActions.duplicateRow(btn);
    }
}

// Update status
function updateStatus(select, taskId) {
    if (taskId === 'NEW') {
        // Mark row as dirty
        const tr = select.closest('tr');
        tr.setAttribute('data-dirty', 'true');
        if (window.TaskActions) {
            window.TaskActions.updateSaveAllButton();
        }
        return;
    }
    
    fetch(`/api/task/${taskId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: select.value })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            showFlash('ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i', 'success');
        }
    })
    .catch(() => {
        showFlash('L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i', 'error');
    });
}

// Initialize on page load
$(document).ready(function() {
    console.log('üîç DEBUG: Page loaded, initializing datetime pickers...');
    console.log('  - Found inputs:', document.querySelectorAll('.datetime-input').length);
    console.log('  - DateTimePicker available:', typeof window.DateTimePicker !== 'undefined');

    // Initialize DataTables cho tasks table
    if ($('#tasks-table').length) {
        // Detect screen width
        const isMobile = window.innerWidth < 768;
        
        const tasksTable = $('#tasks-table').DataTable({
            "scrollX": true,
            "scrollCollapse": true,
            // ‚úÖ Ch·ªâ enable FixedColumns khi KH√îNG ph·∫£i mobile
            "fixedColumns": isMobile ? false : {
                leftColumns: 2
            },
            "responsive": false,
            "lengthChange": true,
            "autoWidth": false,
            // ‚úÖ FIX 3: M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã 10 d√≤ng
            "pageLength": 10,
            "lengthMenu": [[5, 10, 25, 50, 100, -1], [5, 10, 25, 50, 100, "T·∫•t c·∫£"]],
            "order": [[0, "asc"]],
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/vi.json"
            },
            "dom": "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                "<'row'<'col-sm-12'tr>>" +
                "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
            // ‚úÖ FIX 4: T·∫Øt live search, ch·ªâ search khi enter ho·∫∑c click button
            "searchDelay": 0, // Disable delay (we'll handle manually)
            "drawCallback": function(settings) {
                // Re-initialize datetime pickers sau khi DataTables redraw
                if (window.DateTimePicker && window.DateTimePicker.initializeDateTimePickers) {
                    window.DateTimePicker.initializeDateTimePickers();
                }
                if (window.DateTimeCopyPaste && window.DateTimeCopyPaste.initializeCopyPaste) {
                    window.DateTimeCopyPaste.initializeCopyPaste();
                }
                restoreAllReferenceNotes();
            },
            "columnDefs": [
                {
                    "targets": [0, 1],
                    "orderable": false
                },
                {
                    "targets": 16,
                    "orderable": false
                }
            ]
        });
        
        // ‚úÖ FIX 4: Custom search behavior - ch·ªâ search khi Enter ho·∫∑c click button
        const searchInput = $('#tasks-table_wrapper .dataTables_filter input');
        let searchTimeout;
        
        // Disable default live search
        searchInput.off('keyup.DT input.DT');
        
        // T·∫°o search button
        const searchButton = $('<button type="button" class="btn btn-sm btn-primary ms-2" id="search-btn"><i class="fas fa-search"></i></button>');
        searchInput.after(searchButton);
        
        // Function ƒë·ªÉ th·ª±c hi·ªán search
        function performSearch() {
            const searchValue = searchInput.val();
            tasksTable.search(searchValue).draw();
        }
        
        // Search khi click button
        searchButton.on('click', function() {
            performSearch();
        });
        
        // Search khi nh·∫•n Enter
        searchInput.on('keypress', function(e) {
            if (e.which === 13) { // Enter key
                e.preventDefault();
                performSearch();
            }
        });
        
        // Optional: Clear search khi x√≥a h·∫øt text
        searchInput.on('input', function() {
            if ($(this).val() === '') {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(function() {
                    performSearch();
                }, 300); // Auto search khi x√≥a h·∫øt (delay 300ms)
            }
        });
        
        // ‚úÖ Store DataTable instance globally NGAY SAU KHI KH·ªûI T·∫†O
        window.tasksDataTable = tasksTable;
        console.log('‚úÖ DataTable stored:', window.tasksDataTable !== undefined);
        
    } else {
        console.error('‚ùå tasks-table element not found!');
    }

    // Initialize datetime pickers
    if (window.DateTimePicker && window.DateTimePicker.initializeDateTimePickers) {
        console.log('  - Calling initializeDateTimePickers...');
        window.DateTimePicker.initializeDateTimePickers();
    } else {
        console.error('‚ùå DateTimePicker not available!');
    }

    // Initialize copy/paste
    if (window.DateTimeCopyPaste && window.DateTimeCopyPaste.initializeCopyPaste) {
        window.DateTimeCopyPaste.initializeCopyPaste();
    }

    // Initialize task actions v√† t·∫°o Save All button
    if (window.TaskActions) {
        if (window.TaskActions.createSaveAllButton) {
            window.TaskActions.createSaveAllButton();
        }
        if (window.TaskActions.updateSaveAllButton) {
            window.TaskActions.updateSaveAllButton();
        }
    }

    // Restore reference notes on page load
    restoreAllReferenceNotes();
    
    // Track form changes for beforeunload warning
    let formChanged = false;
    const forms = document.querySelectorAll('form, .task-table');
    forms.forEach(function(form) {
        form.addEventListener('change', function() {
            formChanged = true;
        });
    });
    
    window.addEventListener('beforeunload', function(e) {
        const hasDirtyRows = document.querySelectorAll('[data-dirty="true"]').length > 0;
        if (formChanged || hasDirtyRows) {
            e.preventDefault();
            e.returnValue = 'B·∫°n c√≥ thay ƒë·ªïi ch∆∞a l∆∞u. B·∫°n c√≥ ch·∫Øc mu·ªën r·ªùi kh·ªèi trang?';
            return e.returnValue;
        }
    });
}); // ‚úÖ ƒê√≥ng $(document).ready
</script>
{% endblock %}