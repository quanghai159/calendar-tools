{% extends "base.html" %}
{% block title %}Cài đặt cá nhân{% endblock %}

{% block content %}
<div class="row">
  <div class="col-lg-10 mx-auto">
    <div class="card shadow-sm">
      <div class="card-body p-4">
        <h3 class="mb-3"><i class="fas fa-user-cog me-2"></i>Cài đặt cá nhân</h3>

        <form method="POST" class="needs-validation" novalidate>
          <!-- Thông tin tài khoản -->
          <h5 class="mt-4">Thông tin tài khoản</h5>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Tên hiển thị</label>
              <input name="display_name" class="form-control" value="{{ current.display_name }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Avatar URL</label>
              <input name="avatar_url" class="form-control" value="{{ current.avatar_url }}">
            </div>
            <div class="col-md-4">
              <label class="form-label">Số điện thoại</label>
              <input name="phone_number" class="form-control" value="{{ current.phone_number }}">
            </div>
            <div class="col-md-4">
              <label class="form-label">Công ty</label>
              <input name="company" class="form-control" value="{{ current.company }}">
            </div>
            <div class="col-md-4">
              <label class="form-label">Phòng ban</label>
              <input name="department" class="form-control" value="{{ current.department }}">
            </div>
            <div class="col-md-4">
              <label class="form-label">Chức danh</label>
              <input name="role_title" class="form-control" value="{{ current.role_title }}">
            </div>
            <div class="col-md-4">
              <label class="form-label">Email phụ</label>
              <input name="email_alt" type="email" class="form-control" value="{{ current.email_alt }}">
            </div>
          </div>

          <!-- Liên lạc -->
          <h5 class="mt-4">Liên lạc</h5>
          <div class="row g-3">
            <!-- Telegram User ID -->
            <div class="row mb-3">
                <label for="telegram_user_id" class="col-md-4 col-form-label">
                    <i class="fab fa-telegram-plane text-primary"></i> Telegram User ID
                </label>
                <div class="col-md-8">
                    <div class="input-group">
                        <input type="text" class="form-control" id="telegram_user_id" name="telegram_user_id" 
                            value="{{ current.telegram_user_id or '' }}" 
                            placeholder="Nhập Telegram User ID">
                        <button type="button" class="btn btn-outline-primary" onclick="getTelegramId()">
                            <i class="fas fa-search"></i> Lấy ID tự động
                        </button>
                    </div>
                    <div class="form-text">
                        <strong>Cách lấy ID:</strong><br>
                        1. Nhắn tin cho <a href="https://t.me/userinfobot" target="_blank">@userinfobot</a><br>
                        2. Bot sẽ trả về ID của bạn<br>
                        3. Copy ID và paste vào ô trên
                    </div>
                </div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Zalo Phone</label>
              <input name="zalo_phone" class="form-control" value="{{ current.zalo_phone }}">
            </div>
            <div class="col-md-4">
              <label class="form-label">Zalo User ID</label>
              <input name="zalo_user_id" class="form-control" value="{{ current.zalo_user_id }}">
            </div>
            <div class="col-md-8">
              <label class="form-label">Facebook Profile URL</label>
              <input name="facebook_profile_url" class="form-control" value="{{ current.facebook_profile_url }}">
            </div>
          </div>

          <!-- Cài đặt chung -->
          <h5 class="mt-4">Cài đặt chung</h5>
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Múi giờ</label>
              <input name="timezone" class="form-control" value="{{ current.timezone }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Ngôn ngữ</label>
              <input name="language" class="form-control" value="{{ current.language }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Định dạng ngày</label>
              <input name="date_format" class="form-control" value="{{ current.date_format }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Định dạng giờ</label>
              <input name="time_format" class="form-control" value="{{ current.time_format }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Ngày bắt đầu tuần</label>
              <input name="week_start" class="form-control" value="{{ current.week_start }}">
            </div>
            <div class="col-md-9">
              <label class="form-label">Thứ tự kênh noti (JSON)</label>
              <input name="notification_channel_priority" class="form-control" value='{{ current.notification_channel_priority }}'>
            </div>
          </div>

          <!-- Thông báo -->
          <h5 class="mt-4">Thông báo</h5>
          <div class="row g-3">
            <div class="col-md-3 form-check">
              <input type="checkbox" name="notify_via_telegram" class="form-check-input" id="nvtele"
                {% if current.notify_via_telegram == '1' %}checked{% endif %}>
              <label class="form-check-label" for="nvtele">Telegram</label>
            </div>
            <div class="col-md-3 form-check">
              <input type="checkbox" name="notify_via_zalo" class="form-check-input" id="nvzalo"
                {% if current.notify_via_zalo == '1' %}checked{% endif %}>
              <label class="form-check-label" for="nvzalo">Zalo</label>
            </div>
            <div class="col-md-3 form-check">
              <input type="checkbox" name="notify_via_email" class="form-check-input" id="nvemail"
                {% if current.notify_via_email == '1' %}checked{% endif %}>
              <label class="form-check-label" for="nvemail">Email</label>
            </div>
            <div class="col-md-3 form-check">
              <input type="checkbox" name="quiet_hours_enabled" class="form-check-input" id="qhen"
                {% if current.quiet_hours_enabled == '1' %}checked{% endif %}>
              <label class="form-check-label" for="qhen">Giờ yên lặng</label>
            </div>
            <div class="col-md-4">
              <label class="form-label">Khoảng yên lặng</label>
              <input name="quiet_hours_range" class="form-control" value="{{ current.quiet_hours_range }}">
            </div>
            <div class="col-md-3 form-check">
              <input type="checkbox" name="daily_digest_enabled" class="form-check-input" id="dde"
                {% if current.daily_digest_enabled == '1' %}checked{% endif %}>
              <label class="form-check-label" for="dde">Báo cáo hàng ngày</label>
            </div>
            <div class="col-md-3">
              <label class="form-label">Giờ gửi báo cáo</label>
              <input name="daily_digest_time" class="form-control" value="{{ current.daily_digest_time }}">
            </div>
          </div>

          <!-- Calendar Tools -->
          <h5 class="mt-4">Calendar Tools</h5>
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Thời lượng mặc định (phút)</label>
              <input name="default_event_duration" class="form-control" value="{{ current.default_event_duration }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Danh mục mặc định</label>
              <input name="default_category" class="form-control" value="{{ current.default_category }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Nhắc trước (phút)</label>
              <input name="notification_lead_time" class="form-control" value="{{ current.notification_lead_time }}">
            </div>
            <div class="col-md-3 form-check">
              <input type="checkbox" name="auto_add_telegram_reminder" class="form-check-input" id="aatr"
                {% if current.auto_add_telegram_reminder == '1' %}checked{% endif %}>
              <label class="form-check-label" for="aatr">Tự tạo Telegram reminder</label>
            </div>
          </div>

          <!-- Tích hợp & Bảo mật -->
          <h5 class="mt-4">Tích hợp & Bảo mật</h5>
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">CRM API Key</label>
              <input name="crm_api_key" class="form-control" value="{{ current.crm_api_key }}">
            </div>
            <div class="col-md-4">
              <label class="form-label">CRM Endpoint</label>
              <input name="crm_endpoint" class="form-control" value="{{ current.crm_endpoint }}">
            </div>
            <div class="col-md-4">
              <label class="form-label">GA Property ID</label>
              <input name="ga_property_id" class="form-control" value="{{ current.ga_property_id }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Webhook URL</label>
              <input name="webhook_url" class="form-control" value="{{ current.webhook_url }}">
            </div>
            <div class="col-md-3 form-check">
              <input type="checkbox" name="2fa_enabled" class="form-check-input" id="2fa"
                {% if current['2fa_enabled'] == '1' %}checked{% endif %}>
              <label class="form-check-label" for="2fa">Bật 2FA</label>
            </div>
            <div class="col-md-3">
              <label class="form-label">Email khôi phục</label>
              <input name="backup_email" class="form-control" value="{{ current.backup_email }}">
            </div>
            <div class="col-12">
              <label class="form-label">Danh sách IP cho phép (JSON)</label>
              <input name="allowed_ips" class="form-control" value='{{ current.allowed_ips }}'>
            </div>
          </div>

          <div class="mt-4 d-flex gap-2">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-1"></i>Lưu cài đặt
            </button>
            <a href="{{ url_for('index') }}" class="btn btn-secondary">Hủy</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
    function getTelegramId() {
        // Mở @userinfobot trong tab mới
        window.open('https://t.me/userinfobot', '_blank');
        
        // Hiển thị hướng dẫn
        alert('Hướng dẫn:\n\n1. Tab mới sẽ mở @userinfobot\n2. Nhắn tin bất kỳ cho bot\n3. Bot sẽ trả về ID của bạn\n4. Copy ID và paste vào ô "Telegram User ID"');
    }
    </script>

{% endblock %}